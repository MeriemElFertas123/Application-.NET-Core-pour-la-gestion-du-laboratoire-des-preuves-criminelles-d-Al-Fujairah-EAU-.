@page
@model WebApplication1.Pages.Account.ChangePasswordModel
@{
    ViewData["Title"] = "Changer le mot de passe";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fas fa-lock"></i> Changer le mot de passe</h4>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form method="post" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Conseils de sécurité :</strong>
                            <ul class="mb-0 mt-2">
                                <li>Utilisez au moins 8 caractères</li>
                                <li>Mélangez majuscules, minuscules, chiffres et symboles</li>
                                <li>Évitez les informations personnelles</li>
                            </ul>
                        </div>

                        <div class="form-group mb-3">
                            <label for="CurrentPassword" class="form-label">Mot de passe actuel *</label>
                            <div class="input-group">
                                <input asp-for="Input.CurrentPassword" class="form-control" required id="currentPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                    <i class="fas fa-eye" id="eyeCurrentPassword"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Input.CurrentPassword" class="invalid-feedback"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label for="NewPassword" class="form-label">Nouveau mot de passe *</label>
                            <div class="input-group">
                                <input asp-for="Input.NewPassword" class="form-control" required id="newPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye" id="eyeNewPassword"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Input.NewPassword" class="invalid-feedback"></span>
                            <div class="form-text">
                                <div id="passwordStrength" class="mt-2">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="passwordStrengthText">Force du mot de passe</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="ConfirmPassword" class="form-label">Confirmer le nouveau mot de passe *</label>
                            <div class="input-group">
                                <input asp-for="Input.ConfirmPassword" class="form-control" required id="confirmPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye" id="eyeConfirmPassword"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Input.ConfirmPassword" class="invalid-feedback"></span>
                            <div id="passwordMatch" class="form-text"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-page="/Account/Profile" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Retour au profil
                            </a>
                            <button type="submit" class="btn btn-warning" id="btnSubmit">
                                <i class="fas fa-save"></i> Changer le mot de passe
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            // Validation Bootstrap
            (function () {
                'use strict';
                window.addEventListener('load', function () {
                    var forms = document.getElementsByClassName('needs-validation');
                    var validation = Array.prototype.filter.call(forms, function (form) {
                        form.addEventListener('submit', function (event) {
                            if (form.checkValidity() === false) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });
                }, false);
            })();

            // Toggle password visibility
            $('#toggleCurrentPassword').click(function () {
                togglePasswordVisibility('#currentPassword', '#eyeCurrentPassword');
            });

            $('#toggleNewPassword').click(function () {
                togglePasswordVisibility('#newPassword', '#eyeNewPassword');
            });

            $('#toggleConfirmPassword').click(function () {
                togglePasswordVisibility('#confirmPassword', '#eyeConfirmPassword');
            });

            function togglePasswordVisibility(passwordField, eyeIcon) {
                var field = $(passwordField);
                var icon = $(eyeIcon);

                if (field.attr('type') === 'password') {
                    field.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    field.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            }

            // Password strength indicator
            $('#newPassword').on('input', function () {
                var password = $(this).val();
                var strength = calculatePasswordStrength(password);
                updatePasswordStrengthUI(strength);
            });

            // Password match indicator
            $('#confirmPassword').on('input', function () {
                var newPassword = $('#newPassword').val();
                var confirmPassword = $(this).val();
                var matchDiv = $('#passwordMatch');

                if (confirmPassword.length > 0) {
                    if (newPassword === confirmPassword) {
                        matchDiv.html('<i class="fas fa-check text-success"></i> Les mots de passe correspondent')
                            .removeClass('text-danger').addClass('text-success');
                    } else {
                        matchDiv.html('<i class="fas fa-times text-danger"></i> Les mots de passe ne correspondent pas')
                            .removeClass('text-success').addClass('text-danger');
                    }
                } else {
                    matchDiv.html('');
                }
            });

            function calculatePasswordStrength(password) {
                var score = 0;
                var feedback = [];

                if (password.length >= 8) {
                    score += 25;
                } else {
                    feedback.push("Au moins 8 caractères");
                }

                if (/[a-z]/.test(password)) {
                    score += 25;
                } else {
                    feedback.push("Une minuscule");
                }

                if (/[A-Z]/.test(password)) {
                    score += 25;
                } else {
                    feedback.push("Une majuscule");
                }

                if (/[0-9]/.test(password)) {
                    score += 12.5;
                } else {
                    feedback.push("Un chiffre");
                }

                if (/[^A-Za-z0-9]/.test(password)) {
                    score += 12.5;
                } else {
                    feedback.push("Un symbole");
                }

                return {
                    score: Math.min(score, 100),
                    feedback: feedback
                };
            }

            function updatePasswordStrengthUI(strength) {
                var progressBar = $('#passwordStrength .progress-bar');
                var strengthText = $('#passwordStrengthText');

                progressBar.css('width', strength.score + '%');

                if (strength.score < 25) {
                    progressBar.removeClass().addClass('progress-bar bg-danger');
                    strengthText.text('Très faible');
                } else if (strength.score < 50) {
                    progressBar.removeClass().addClass('progress-bar bg-warning');
                    strengthText.text('Faible');
                } else if (strength.score < 75) {
                    progressBar.removeClass().addClass('progress-bar bg-info');
                    strengthText.text('Moyen');
                } else if (strength.score < 100) {
                    progressBar.removeClass().addClass('progress-bar bg-success');
                    strengthText.text('Fort');
                } else {
                    progressBar.removeClass().addClass('progress-bar bg-success');
                    strengthText.text('Très fort');
                }

                if (strength.feedback.length > 0) {
                    strengthText.text(strengthText.text() + ' - Manque: ' + strength.feedback.join(', '));
                }
            }

            // Disable submit if passwords don't match
            $('form').on('submit', function (e) {
                var newPassword = $('#newPassword').val();
                var confirmPassword = $('#confirmPassword').val();

                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('Les mots de passe ne correspondent pas');
                    return false;
                }

                $('#btnSubmit').html('<i class="fas fa-spinner fa-spin"></i> Changement en cours...');
            });
        });
    </script>

    <style>
        .input-group .btn {
            border-color: #ced4da;
        }

        .progress {
            height: 5px !important;
        }

        #passwordStrengthText {
            font-size: 0.8em;
        }

        .alert ul {
            padding-left: 20px;
        }
    </style>
}