@model WebApplication1.Models.Stockage.StockerEchantillonViewModel
@{
    ViewBag.Title = "Stocker un Échantillon";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";
}

<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">@Html.ActionLink("Stockage", "Index")</li>
                <li class="breadcrumb-item active">Stocker échantillon</li>
            </ol>
        </nav>
        <h2><i class="fas fa-warehouse text-primary"></i> Stocker un Échantillon</h2>
        <p class="text-muted">Attribution d'un emplacement de stockage pour l'échantillon @Model.Echantillon.NumeroEchantillon</p>
    </div>
</div>

<div class="row">
    <!-- Informations sur l'échantillon -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-vial"></i> Informations Échantillon</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>N° Échantillon:</strong></td>
                        <td>@Model.Echantillon.NumeroEchantillon</td>
                    </tr>
                    <tr>
                        <td><strong>N° Affaire:</strong></td>
                        <td>@Model.Echantillon.NumeroAffaire</td>
                    </tr>
                    <tr>
                        <td><strong>Type:</strong></td>
                        <td>
                            <span class="badge bg-primary">@Model.Echantillon.Type</span>
                        </td>
                    </tr>

                    <tr>
                        <td><strong>Date réception:</strong></td>
                        <td>@Model.Echantillon.DateReception.ToString("dd/MM/yyyy HH:mm")</td>
                    </tr>
                    <tr>
                        <td><strong>Statut:</strong></td>
                        <td>
                            <span class="badge bg-success">@Model.Echantillon.Statut</span>
                        </td>
                    </tr>
                </table>

                @if (!string.IsNullOrEmpty(Model.Echantillon.Description))
                {
                    <div class="mt-3">
                        <strong>Description:</strong>
                        <p class="text-muted small">@Model.Echantillon.Description</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.Echantillon.ConditionsStockage))
                {
                    <div class="alert alert-warning mt-3">
                        <strong><i class="fas fa-exclamation-triangle"></i> Conditions spéciales:</strong><br>
                        @Model.Echantillon.ConditionsStockage
                    </div>
                }
            </div>
        </div>

        <!-- Zones compatibles -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-check-circle"></i> Zones Compatibles</h6>
            </div>
            <div class="card-body">
                @foreach (var zone in Model.ZonesDisponibles)
                {
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>Zone @zone.Code</strong><br>
                            <small class="text-muted">@zone.Nom</small><br>
                            <small><i class="fas fa-thermometer-half"></i> @zone.Temperature</small>
                        </div>
                        <div class="text-end">
                            <span class="badge @(zone.Libre == 0 ? "bg-danger" : zone.Libre < 5 ? "bg-warning" : "bg-success")">
                                @zone.Libre libres
                            </span>
                        </div>
                    </div>
                }

                @if (!Model.ZonesDisponibles.Any())
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Aucune zone compatible disponible
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Formulaire de stockage -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Attribution d'Emplacement</h5>
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Stocker", "Stockage", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.Echantillon.Id)

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            @Html.LabelFor(m => m.ZoneSelectionnee, new { @class = "form-label required" })
                            @Html.DropDownListFor(m => m.ZoneSelectionnee,
                            new SelectList(Model.ZonesDisponibles, "Code", "Nom"),
                                                "Sélectionnez une zone",
                                                new { @class = "form-select", required = "required", onchange = "chargerEmplacements()" })
                        @Html.ValidationMessageFor(m => m.ZoneSelectionnee, "", new { @class = "invalid-feedback" })
                    </div>

                    <div class="col-md-6 mb-3">
                        @Html.LabelFor(m => m.EmplacementSelectionne, new { @class = "form-label required" })
                        @Html.DropDownListFor(m => m.EmplacementSelectionne,
                                                new SelectList(Enumerable.Empty<SelectListItem>()),
                                                "Sélectionnez d'abord une zone",
                                                new { @class = "form-select", required = "required", disabled = "disabled" })
                        @Html.ValidationMessageFor(m => m.EmplacementSelectionne, "", new { @class = "invalid-feedback" })
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        @Html.LabelFor(m => m.DateLimite, new { @class = "form-label" })
                        @Html.TextBoxFor(m => m.DateLimite, new { @class = "form-control", @type = "date", @min = DateTime.Now.ToString("yyyy-MM-dd") })
                        @Html.ValidationMessageFor(m => m.DateLimite, "", new { @class = "invalid-feedback" })
                        <div class="form-text">Date limite recommandée pour ce type d'échantillon</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            @Html.CheckBoxFor(m => m.EstPrioritaire, new { @class = "form-check-input" })
                            @Html.LabelFor(m => m.EstPrioritaire, "Stockage prioritaire", new { @class = "form-check-label" })
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    @Html.LabelFor(m => m.ConditionsSpeciales, new { @class = "form-label" })
                    @Html.TextAreaFor(m => m.ConditionsSpeciales, new { @class = "form-control", @rows = 3, @placeholder = "Conditions spéciales de stockage, précautions particulières..." })
                    @Html.ValidationMessageFor(m => m.ConditionsSpeciales, "", new { @class = "invalid-feedback" })
                </div>

                <!-- Aperçu de l'emplacement sélectionné -->
                <div class="alert alert-info" id="apercu-emplacement" style="display: none;">
                    <h6><i class="fas fa-info-circle"></i> Aperçu de l'emplacement</h6>
                    <div id="info-emplacement"></div>
                </div>

                <!-- Boutons d'action -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                @Html.ActionLink("Annuler", "Index", null, new { @class = "btn btn-secondary" })
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="verifierDisponibilite()">
                                    <i class="fas fa-search"></i> Vérifier disponibilité
                                </button>
                                <button type="submit" class="btn btn-success" id="btn-stocker" disabled>
                                    <i class="fas fa-save"></i> Confirmer le stockage
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                                }
            </div>
        </div>

        <!-- Historique des actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-history"></i> Historique</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Échantillon reçu</h6>
                            <p class="mb-0 text-muted">@Model.Echantillon.DateReception.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Vérification effectuée</h6>
                            <p class="mb-0 text-muted">@DateTime.Now.AddMinutes(-30).ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>
                    <div class="timeline-item active">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">En cours de stockage</h6>
                            <p class="mb-0 text-muted">Maintenant</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Document prêt');

            // Validation du formulaire
            $('form').on('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(this).addClass('was-validated');
            });

            // Calculer la date limite recommandée
            calculerDateLimiteRecommandee();

            // Activer les tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function chargerEmplacements() {
            var zone = $('#ZoneSelectionnee').val();
            var emplacementSelect = $('#EmplacementSelectionne');

            console.log('Chargement emplacements pour zone:', zone);

            if (!zone) {
                emplacementSelect.prop('disabled', true).html('<option>Sélectionnez d\'abord une zone</option>');
                $('#btn-stocker').prop('disabled', true);
                $('#apercu-emplacement').hide();
                return;
            }

            // Afficher un indicateur de chargement
            emplacementSelect.html('<option>Chargement des emplacements...</option>').prop('disabled', true);

            // Charger les emplacements via AJAX
            $.ajax({
                url: '@Url.Action("GetEmplacements", "Stockage")',
                type: 'GET',
                data: { zone: zone },
                dataType: 'json',
                success: function(data) {
                    console.log('Zone sélectionnée:', zone);
                    console.log('Données reçues:', data);
                    console.log('Premier élément:', data[0]);
                    console.log('Structure du premier élément:', Object.keys(data[0] || {}));

                    var options = '<option value="">Sélectionnez un emplacement</option>';
                    var libres = 0;
                    var occupes = 0;

                    if (data && data.length > 0) {
                        $.each(data, function(index, item) {
                            // Gestion de différents formats de données
                            var value = item.Value || item.value || item.Numero || item.numero || '';
                            var text = item.Text || item.text || (value + (item.EstOccupe || item.estOccupe ? ' (Occupé)' : ' (Libre)'));
                            var disabled = item.Disabled || item.disabled || item.EstOccupe || item.estOccupe || false;
                            var estOccupe = item.EstOccupe || item.estOccupe || false;

                            console.log('Item complet:', item);
                            console.log('Emplacement:', value, 'Occupé:', estOccupe, 'Disabled:', disabled);

                            if (value && value.trim() !== '') {
                                if (disabled) {
                                    occupes++;
                                    options += '<option value="' + value + '" disabled>' + text + '</option>';
                                } else {
                                    libres++;
                                    options += '<option value="' + value + '">' + text + '</option>';
                                }
                            } else {
                                console.warn('Emplacement ignoré - valeur vide:', item);
                            }
                        });

                        console.log('Emplacements libres:', libres, 'Emplacements occupés:', occupes);
                    } else {
                        options = '<option value="">Aucun emplacement disponible dans cette zone</option>';
                        console.log('Aucun emplacement trouvé pour la zone:', zone);
                    }

                    emplacementSelect.html(options).prop('disabled', false);

                    // Activer l'événement change pour l'emplacement
                    emplacementSelect.off('change').on('change', function() {
                        var selectedEmplacement = $(this).val();
                        console.log('Emplacement sélectionné:', selectedEmplacement);
                        if (selectedEmplacement) {
                            afficherApercuEmplacement(zone, selectedEmplacement);
                            $('#btn-stocker').prop('disabled', false);
                        } else {
                            $('#apercu-emplacement').hide();
                            $('#btn-stocker').prop('disabled', true);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Erreur AJAX GetEmplacements:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);

                    emplacementSelect.html('<option>Erreur de chargement</option>').prop('disabled', true);
                    alert('Erreur lors du chargement des emplacements: ' + error);
                }
            });
        }

        function verifierDisponibilite() {
            var zone = $('#ZoneSelectionnee').val();
            var emplacement = $('#EmplacementSelectionne').val();

            if (!zone || !emplacement) {
                alert('Veuillez sélectionner une zone et un emplacement');
                return;
            }

            console.log('Vérification disponibilité pour:', zone, emplacement);

            // Afficher un indicateur de chargement
            var btnVerifier = $('button[onclick="verifierDisponibilite()"]');
            var originalText = btnVerifier.html();
            btnVerifier.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Vérification...');

            // Vérifier la disponibilité via AJAX
            $.ajax({
                url: '@Url.Action("VerifierDisponibilite", "Stockage")',
                type: 'GET',
                data: {
                    zone: zone,
                    emplacement: emplacement
                },
                dataType: 'json',
                success: function(data) {
                    console.log('Réponse vérification:', data);

                    // Restaurer le bouton
                    btnVerifier.prop('disabled', false).html(originalText);

                    if (data.Disponible) {
                        alert('✓ ' + data.Message);
                        $('#btn-stocker').prop('disabled', false)
                            .removeClass('btn-secondary')
                            .addClass('btn-success');
                    } else {
                        alert('✗ ' + data.Message);
                        $('#btn-stocker').prop('disabled', true)
                            .removeClass('btn-success')
                            .addClass('btn-secondary');

                        // Recharger les emplacements pour mettre à jour la liste
                        chargerEmplacements();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erreur vérification:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);

                    // Restaurer le bouton
                    btnVerifier.prop('disabled', false).html(originalText);
                    alert('Erreur lors de la vérification de disponibilité: ' + error);
                }
            });
        }

        function afficherApercuEmplacement(zone, emplacement) {
            var info = '<div class="row">';
            info += '<div class="col-md-6">';
            info += '<strong>Emplacement:</strong> ' + zone + '-' + emplacement + '<br>';
            info += '<strong>Zone:</strong> ' + $('#ZoneSelectionnee option:selected').text() + '<br>';
            info += '</div>';
            info += '<div class="col-md-6">';
            info += '<strong>Température:</strong> ' + getTemperatureZone(zone) + '<br>';
            info += '<strong>Conditions:</strong> ' + getConditionsZone(zone);
            info += '</div>';
            info += '</div>';

            $('#info-emplacement').html(info);
            $('#apercu-emplacement').show();
        }

        function getTemperatureZone(zone) {
            var temperatures = {
                'A': '2-8°C (Réfrigéré)',
                'B': '-20°C (Congelé)',
                'C': '15-25°C (Ambiante)',
                'D': 'Contrôlée (Sécurisé)'
            };
            return temperatures[zone] || 'Non définie';
        }

        function getConditionsZone(zone) {
            var conditions = {
                'A': 'Réfrigération continue, protection lumière',
                'B': 'Congélation, étanchéité renforcée',
                'C': 'Température ambiante, ventilation',
                'D': 'Accès sécurisé, conditions spéciales'
            };
            return conditions[zone] || 'Standard';
        }

        function calculerDateLimiteRecommandee() {
            var typeEchantillon = '@Model.Echantillon.Type';
            var dateReception = new Date('@Model.Echantillon.DateReception.ToString("yyyy-MM-dd")');
            var dateLimite = new Date(dateReception);

            // Calculer selon le type d'échantillon
            switch (typeEchantillon) {
                case 'Sang':
                    dateLimite.setDate(dateLimite.getDate() + 30); // 30 jours
                    break;
                case 'Urine':
                    dateLimite.setDate(dateLimite.getDate() + 60); // 60 jours
                    break;
                case 'Solide':
                    dateLimite.setDate(dateLimite.getDate() + 90); // 90 jours
                    break;
                case 'Liquide':
                    dateLimite.setDate(dateLimite.getDate() + 45); // 45 jours
                    break;
                case 'Biologique':
                    dateLimite.setDate(dateLimite.getDate() + 21); // 21 jours
                    break;
                default:
                    dateLimite.setDate(dateLimite.getDate() + 30); // 30 jours par défaut
            }

            // Définir la date recommandée dans le champ
            var dateLimiteString = dateLimite.toISOString().split('T')[0];
            $('#DateLimite').val(dateLimiteString);
        }

        // Validation en temps réel
        $('.form-control, .form-select').on('blur', function() {
            var field = $(this);
            if (field.val() && field[0].checkValidity()) {
                field.removeClass('is-invalid').addClass('is-valid');
            } else {
                field.removeClass('is-valid').addClass('is-invalid');
            }
        });

        // Raccourcis clavier
        $(document).keydown(function(e) {
            // Ctrl+S pour sauvegarder
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (!$('#btn-stocker').prop('disabled')) {
                    $('form').submit();
                }
            }

            // Escape pour annuler
            if (e.key === 'Escape') {
                if (confirm('Annuler le stockage de cet échantillon ?')) {
                    window.location.href = '@Url.Action("Index", "Stockage")';
                }
            }
        });

        // Confirmation avant soumission
        $('form').on('submit', function(e) {
            var zone = $('#ZoneSelectionnee').val();
            var emplacement = $('#EmplacementSelectionne').val();
            var echantillon = '@Model.Echantillon.NumeroEchantillon';

            if (!confirm('Confirmer le stockage de l\'échantillon ' + echantillon + ' à l\'emplacement ' + zone + '-' + emplacement + ' ?')) {
                e.preventDefault();
            }
        });
    </script>

    <style>
        .required::after {
            content: " *";
            color: red;
        }

        .timeline {
            position: relative;
            padding: 0;
            margin: 0;
        }

            .timeline::before {
                content: '';
                position: absolute;
                top: 0;
                left: 15px;
                height: 100%;
                width: 2px;
                background: #e9ecef;
            }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 40px;
        }

        .timeline-marker {
            position: absolute;
            left: 6px;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #e9ecef;
        }

        .timeline-item.active .timeline-marker {
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%

        {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }

        }

        .timeline-content h6 {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .timeline-content p {
            font-size: 12px;
            margin: 0;
        }

        .card-header.bg-info,
        .card-header.bg-primary,
        .card-header.bg-success {
            border: none;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .btn-success:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .alert {
            border-radius: 8px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .badge {
            font-size: 0.8em;
        }
    </style>
}