@model List<WebApplication1.Models.Emploi.EmploiTemps>
@{
    ViewBag.Title = "Historique des Emplois du Temps";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";
}

<div class="container-fluid px-4 py-4">
    <!-- En-tête -->
    <div class="history-header mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="history-badge">
                    <i class="fas fa-history"></i>
                </div>
                <div class="ms-3">
                    <h1 class="history-title">Historique des Emplois du Temps</h1>
                    <p class="history-subtitle">Consultation et analyse des planifications antérieures</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
               
                <a asp-controller="EmploiTemps" asp-action="CreerEmploiTemps" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Nouvel Emploi du Temps
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques générales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card total-card">
                <div class="stats-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-number">@ViewBag.TotalSchedules</div>
                    <div class="stats-label">Total Emplois du Temps</div>
                    <div class="stats-period">Année @ViewBag.CurrentYear</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card approved-card">
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-number">@ViewBag.ApprovedSchedules</div>
                    <div class="stats-label">Approuvés</div>
                    <div class="stats-period">@(ViewBag.TotalSchedules > 0 ? Math.Round((double)ViewBag.ApprovedSchedules / ViewBag.TotalSchedules * 100, 1) : 0)% du total</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card archived-card">
                <div class="stats-icon">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-number">@ViewBag.ArchivedSchedules</div>
                    <div class="stats-label">Archivés</div>
                    <div class="stats-period">@(ViewBag.TotalSchedules > 0 ? Math.Round((double)ViewBag.ArchivedSchedules / ViewBag.TotalSchedules * 100, 1) : 0)% du total</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card average-card">
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-number">@(Model.Any() ? Math.Round(Model.Where(m => m.Statut == "Approved").Average(m => (double?)m.TauxCouverture) ?? 0, 1) : 0)%</div>
                    <div class="stats-label">Taux Couverture Moyen</div>
                    <div class="stats-period">Emplois approuvés</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <form asp-controller="EmploiTemps" asp-action="HistoriqueEmploisTemps" method="get" class="filters-form">
        <div class="filters-card mb-4">
            <div class="filters-header">
                <h5><i class="fas fa-filter"></i> Filtres et Recherche</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Réinitialiser
                </button>
            </div>
            <div class="filters-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Année</label>
                        <select name="year" class="form-select">
                            <option value="">Toutes les années</option>
                            @for (int y = DateTime.Now.Year - 2; y <= DateTime.Now.Year + 2; y++)
                            {
                                <option value="@y" selected="@(y == ViewBag.CurrentYear)">@y</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Statut</label>
                        <select name="status" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="Draft" selected="@(Context.Request.Query["status"] == "Draft")">Brouillon</option>
                            <option value="Pending" selected="@(Context.Request.Query["status"] == "Pending")">En attente</option>
                            <option value="Approved" selected="@(Context.Request.Query["status"] == "Approved")">Approuvé</option>
                            <option value="Archived" selected="@(Context.Request.Query["status"] == "Archived")">Archivé</option>
                            <option value="Cancelled" selected="@(Context.Request.Query["status"] == "Cancelled")">Annulé</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Créé par</label>
                        <select name="creator" class="form-select">
                            <option value="">Tous les créateurs</option>
                            <option value="Administrateur" selected="@(Context.Request.Query["creator"] == "Administrateur")">Dr. Administrateur</option>
                            <option value="Directeur" selected="@(Context.Request.Query["creator"] == "Directeur")">Directeur Laboratoire</option>
                            <option value="Chef" selected="@(Context.Request.Query["creator"] == "Chef")">Chef de Service</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Appliquer
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="toggleAdvancedFilters()">
                                <i class="fas fa-cog"></i> Avancé
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtres avancés (masqués par défaut) -->
                <div class="advanced-filters mt-3" id="advancedFilters" style="display: none;">
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Période de création</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" name="dateFrom" class="form-control" value="@Context.Request.Query["dateFrom"]" placeholder="Du">
                                </div>
                                <div class="col-6">
                                    <input type="date" name="dateTo" class="form-control" value="@Context.Request.Query["dateTo"]" placeholder="Au">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Taux de couverture</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" name="coverageMin" class="form-control" placeholder="Min %" min="0" max="100" value="@Context.Request.Query["coverageMin"]">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="coverageMax" class="form-control" placeholder="Max %" min="0" max="100" value="@Context.Request.Query["coverageMax"]">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Numéro de semaine</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" name="weekFrom" class="form-control" placeholder="De" min="1" max="52" value="@Context.Request.Query["weekFrom"]">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="weekTo" class="form-control" placeholder="À" min="1" max="52" value="@Context.Request.Query["weekTo"]">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Liste des emplois du temps -->
    <div class="history-list-card">
        <div class="history-list-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Liste des Emplois du Temps (@Model.Count résultat@(Model.Count > 1 ? "s" : ""))</h5>
                <div class="list-controls">
                    <select class="form-select form-select-sm" style="width: auto;" onchange="changeSortOrder(this.value)">
                        <option value="week-desc">Semaine (récent)</option>
                        <option value="week-asc">Semaine (ancien)</option>
                        <option value="created-desc">Date création (récent)</option>
                        <option value="created-asc">Date création (ancien)</option>
                        <option value="status">Statut</option>
                        <option value="coverage-desc">Couverture (élevé)</option>
                        <option value="coverage-asc">Couverture (faible)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="history-list-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table history-table">
                        <thead>
                            <tr>
                                <th width="5%">
                                    <input type="checkbox" class="form-check-input" onclick="toggleSelectAll(this)">
                                </th>
                                <th width="10%">Semaine</th>
                                <th width="15%">Période</th>
                                <th width="12%">Statut</th>
                                <th width="12%">Couverture</th>
                                <th width="15%">Créé par</th>
                                <th width="15%">Date création</th>
                                <th width="8%">Personnel</th>
                                <th width="8%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            @foreach (var emploiTemps in Model.OrderByDescending(e => e.NumeroSemaine))
                            {
                                <tr class="schedule-row" data-week="@emploiTemps.NumeroSemaine" data-status="@emploiTemps.Statut.ToLower()" data-coverage="@emploiTemps.TauxCouverture">
                                    <td>
                                        <input type="checkbox" class="form-check-input row-checkbox" value="@emploiTemps.Id">
                                    </td>
                                    <td>
                                        <div class="week-info">
                                            <span class="week-number">@emploiTemps.NumeroSemaine</span>
                                            <small class="week-year">@emploiTemps.Annee</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="period-info">
                                            <div class="period-dates">@emploiTemps.PeriodeAffichage</div>
                                            <small class="period-duration">5 jours</small>
                                        </div>
                                    </td>
                                    <td>
                                        @if (emploiTemps.Statut == "Approved")
                                        {
                                            <span class="status-badge approved">
                                                <i class="fas fa-check-circle"></i> @emploiTemps.StatutLibelle
                                            </span>
                                        }
                                        else if (emploiTemps.Statut == "Archived")
                                        {
                                            <span class="status-badge archived">
                                                <i class="fas fa-archive"></i> @emploiTemps.StatutLibelle
                                            </span>
                                        }
                                        else if (emploiTemps.Statut == "Draft")
                                        {
                                            <span class="status-badge draft">
                                                <i class="fas fa-edit"></i> @emploiTemps.StatutLibelle
                                            </span>
                                        }
                                        else if (emploiTemps.Statut == "Pending")
                                        {
                                            <span class="status-badge pending">
                                                <i class="fas fa-clock"></i> @emploiTemps.StatutLibelle
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="status-badge cancelled">
                                                <i class="fas fa-times-circle"></i> @emploiTemps.StatutLibelle
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="coverage-info">
                                            <div class="coverage-bar">
                                                <div class="coverage-fill @(emploiTemps.TauxCouverture >= 90 ? "" : emploiTemps.TauxCouverture >= 70 ? "low-coverage" : "cancelled-coverage")" style="width: @emploiTemps.TauxCouverture%"></div>
                                            </div>
                                            <span class="coverage-text">@emploiTemps.TauxCouverture%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="creator-info">
                                            <span class="creator-name">@emploiTemps.CreePar</span>
                                            <small class="creator-role">@(emploiTemps.CreePar.Contains("Directeur") ? "Directeur" : emploiTemps.CreePar.Contains("Chef") ? "Chef Service" : "Administrateur")</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="date-info">
                                            <div class="creation-date">@emploiTemps.DateCreation.ToString("dd/MM/yyyy")</div>
                                            <small class="creation-time">@emploiTemps.DateCreation.ToString("HH:mm")</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="staff-count">@emploiTemps.NombrePersonnelAssigne pers.</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a asp-controller="EmploiTemps" asp-action="VoirEmploiTempsSemaine"
                                               asp-route-week="@emploiTemps.NumeroSemaine" asp-route-year="@emploiTemps.Annee"
                                               class="btn btn-sm btn-outline-primary" title="Voir">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"></button>
                                                <ul class="dropdown-menu">
                                                    @if (emploiTemps.Statut == "Draft" || emploiTemps.Statut == "Pending")
                                                    {
                                                        <li>
                                                            <a class="dropdown-item" asp-controller="EmploiTemps" asp-action="ModifierEmploiTemps" asp-route-id="@emploiTemps.Id">
                                                                <i class="fas fa-edit"></i> Modifier
                                                            </a>
                                                        </li>
                                                    }
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="duplicateSchedule(@emploiTemps.Id, @emploiTemps.NumeroSemaine, @emploiTemps.Annee)">
                                                            <i class="fas fa-copy"></i> Dupliquer
                                                        </a>
                                                    </li>
                                                    @if (emploiTemps.Statut == "Draft")
                                                    {
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-primary" href="#" onclick="changeStatus(@emploiTemps.Id, 'Pending')">
                                                                <i class="fas fa-paper-plane"></i> Soumettre
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (emploiTemps.Statut == "Archived")
                                                    {
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-success" href="#" onclick="changeStatus(@emploiTemps.Id, 'Approved')">
                                                                <i class="fas fa-undo"></i> Restaurer
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (emploiTemps.Statut == "Approved")
                                                    {
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-warning" href="#" onclick="changeStatus(@emploiTemps.Id, 'Archived')">
                                                                <i class="fas fa-archive"></i> Archiver
                                                            </a>
                                                        </li>
                                                    }
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" onclick="deleteSchedule(@emploiTemps.Id)">
                                                            <i class="fas fa-trash"></i> Supprimer
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="no-results">
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Aucun emploi du temps trouvé</h4>
                        <p class="text-muted">Aucun emploi du temps ne correspond aux critères de recherche.</p>
                        <a asp-controller="EmploiTemps" asp-action="CreerEmploiTemps" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Créer le premier emploi du temps
                        </a>
                    </div>
                </div>
            }
        </div>

        @if (Model.Any())
        {
            <!-- Actions en masse -->
            <div class="history-list-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="bulk-actions">
                        <button class="btn btn-sm btn-outline-warning" onclick="bulkArchive()" disabled id="bulkArchiveBtn">
                            <i class="fas fa-archive"></i> Archiver sélection
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="bulkDelete()" disabled id="bulkDeleteBtn">
                            <i class="fas fa-trash"></i> Supprimer sélection
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="bulkExport()" disabled id="bulkExportBtn">
                            <i class="fas fa-download"></i> Exporter sélection
                        </button>
                    </div>
                    <div class="results-info">
                        <span class="results-count">@Model.Count résultat@(Model.Count > 1 ? "s" : "") affiché@(Model.Count > 1 ? "s" : "")</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 1050;">
        <i class="fas fa-check-circle me-2"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Modal d'export de rapport -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Générer Rapport d'Historique</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Type de rapport</label>
                    <select class="form-select" id="reportType">
                        <option value="coverage">Rapport de couverture</option>
                        <option value="trends">Analyse des tendances</option>
                        <option value="personnel">Rapport de personnel</option>
                        <option value="complete">Rapport complet</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Format</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="format" id="formatPdf" value="pdf" checked>
                        <label class="form-check-label" for="formatPdf">PDF</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="format" id="formatExcel" value="excel">
                        <label class="form-check-label" for="formatExcel">Excel</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="format" id="formatCsv" value="csv">
                        <label class="form-check-label" for="formatCsv">CSV</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Inclure</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeStats" checked>
                        <label class="form-check-label" for="includeStats">Statistiques</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeDetails" checked>
                        <label class="form-check-label" for="includeDetails">Détails des planifications</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCharts">
                        <label class="form-check-label" for="includeCharts">Graphiques (PDF uniquement)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">Générer Rapport</button>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --schedule-primary: #8b5cf6;
        --schedule-secondary: #a855f7;
        --judicial-primary: #1e3a8a;
        --judicial-success: #16a34a;
        --judicial-warning: #d97706;
        --judicial-danger: #dc2626;
        --judicial-light: #f8fafc;
        --judicial-border: #e2e8f0;
        --judicial-secondary: #64748b;
    }

    body {
        background-color: var(--judicial-light);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .history-header {
        background: linear-gradient(135deg, var(--schedule-primary), var(--schedule-secondary));
        color: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
    }

    .history-badge {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .history-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
    }

    .history-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s;
        border-left: 4px solid;
    }

        .stats-card:hover {
            transform: translateY(-2px);
        }

    .total-card {
        border-left-color: var(--judicial-primary);
    }

    .approved-card {
        border-left-color: var(--judicial-success);
    }

    .archived-card {
        border-left-color: var(--judicial-secondary);
    }

    .average-card {
        border-left-color: var(--judicial-warning);
    }

    .stats-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }

    .total-card .stats-icon {
        background: var(--judicial-primary);
    }

    .approved-card .stats-icon {
        background: var(--judicial-success);
    }

    .archived-card .stats-icon {
        background: var(--judicial-secondary);
    }

    .average-card .stats-icon {
        background: var(--judicial-warning);
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--judicial-primary);
    }

    .stats-label {
        font-size: 0.9rem;
        color: var(--judicial-secondary);
        font-weight: 500;
    }

    .stats-period {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-top: 0.25rem;
    }

    .filters-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .filters-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--judicial-border);
        background: var(--judicial-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .filters-header h5 {
            margin: 0;
            color: var(--judicial-primary);
            font-weight: 600;
        }

    .filters-body {
        padding: 1.5rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--judicial-primary);
        margin-bottom: 0.5rem;
    }

    .history-list-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .history-list-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--judicial-border);
        background: var(--judicial-light);
    }

        .history-list-header h5 {
            margin: 0;
            color: var(--judicial-primary);
            font-weight: 600;
        }

    .history-list-body {
        padding: 0;
    }

    .history-list-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--judicial-border);
        background: var(--judicial-light);
    }

    .history-table {
        margin: 0;
    }

        .history-table th {
            background: var(--judicial-primary);
            color: white;
            border: none;
            padding: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .history-table td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--judicial-border);
        }

        .history-table tbody tr:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }

    .week-info {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .week-number {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--judicial-primary);
    }

    .week-year {
        font-size: 0.8rem;
        color: var(--judicial-secondary);
    }

    .period-info {
        text-align: center;
    }

    .period-dates {
        font-weight: 600;
        color: var(--judicial-primary);
    }

    .period-duration {
        color: var(--judicial-secondary);
        font-size: 0.8rem;
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

        .status-badge.approved {
            background: rgba(22, 163, 74, 0.1);
            color: var(--judicial-success);
        }

        .status-badge.archived {
            background: rgba(100, 116, 139, 0.1);
            color: var(--judicial-secondary);
        }

        .status-badge.draft {
            background: rgba(217, 119, 6, 0.1);
            color: var(--judicial-warning);
        }

        .status-badge.pending {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .status-badge.cancelled {
            background: rgba(220, 38, 38, 0.1);
            color: var(--judicial-danger);
        }

    .coverage-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .coverage-bar {
        flex: 1;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .coverage-fill {
        height: 100%;
        background: var(--judicial-success);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

        .coverage-fill.low-coverage {
            background: var(--judicial-warning);
        }

        .coverage-fill.cancelled-coverage {
            background: var(--judicial-danger);
        }

    .coverage-text {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--judicial-primary);
        min-width: 40px;
    }

    .creator-info {
        display: flex;
        flex-direction: column;
    }

    .creator-name {
        font-weight: 600;
        color: var(--judicial-primary);
    }

    .creator-role {
        color: var(--judicial-secondary);
        font-size: 0.8rem;
    }

    .date-info {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .creation-date {
        font-weight: 600;
        color: var(--judicial-primary);
    }

    .creation-time {
        color: var(--judicial-secondary);
        font-size: 0.8rem;
    }

    .staff-count {
        font-weight: 600;
        color: var(--judicial-primary);
        text-align: center;
        display: block;
    }

    .action-buttons {
        display: flex;
        gap: 0.25rem;
    }

    .bulk-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .results-count {
        color: var(--judicial-secondary);
        font-size: 0.9rem;
    }

    .no-results {
        padding: 2rem;
    }

    .schedule-row:hover {
        transform: translateX(5px);
        transition: transform 0.2s ease;
    }

    media (max-width: 768px) {
        .history-header .d-flex

    {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }

    .stats-card {
        margin-bottom: 1rem;
    }

    .filters-body .row {
        margin-bottom: 1rem;
    }

    .filters-body .col-md-3 {
        margin-bottom: 1rem;
    }

    .history-table {
        font-size: 0.8rem;
    }

    .action-buttons {
        flex-direction: column;
    }

    }

    .advanced-filters {
        animation: slideDown 0.3s ease-out;
    }

   keyframes slideDown {
        from

    {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

<script>
    let selectedSchedules = [];

    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        updateBulkActionButtons();

        // Auto-hide alerts après 5 secondes
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.parentNode) {
                    alert.remove();
                }
            });
        }, 5000);
    });

    function initializeEventListeners() {
        // Checkbox de sélection
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelection();
            });
        });
    }

    function resetFilters() {
        // Rediriger vers la page sans paramètres
        window.location.href = '@Url.Action("HistoriqueEmploisTemps", "EmploiTemps")';
    }

    function toggleAdvancedFilters() {
        const advancedFilters = document.getElementById('advancedFilters');
        if (advancedFilters.style.display === 'none') {
            advancedFilters.style.display = 'block';
        } else {
            advancedFilters.style.display = 'none';
        }
    }

    function changeSortOrder(order) {
        const tbody = document.getElementById('scheduleTableBody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('.schedule-row'));

        rows.sort((a, b) => {
            switch(order) {
                case 'week-desc':
                    return parseInt(b.dataset.week) - parseInt(a.dataset.week);
                case 'week-asc':
                    return parseInt(a.dataset.week) - parseInt(b.dataset.week);
                case 'status':
                    return a.dataset.status.localeCompare(b.dataset.status);
                case 'coverage-desc':
                    return parseFloat(b.dataset.coverage) - parseFloat(a.dataset.coverage);
                case 'coverage-asc':
                    return parseFloat(a.dataset.coverage) - parseFloat(b.dataset.coverage);
                case 'created-desc':
                case 'created-asc':
                    // Tri par date (nécessiterait des données supplémentaires)
                    return 0;
                default:
                    return 0;
            }
        });

        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));

        showNotification(`Tri appliqué: ${order}`, 'info');
    }

    function toggleSelectAll(masterCheckbox) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
        updateSelection();
    }

    function updateSelection() {
        selectedSchedules = [];
        document.querySelectorAll('.row-checkbox:checked').forEach(checkbox => {
            selectedSchedules.push(checkbox.value);
        });
        updateBulkActionButtons();
    }

    function updateBulkActionButtons() {
        const hasSelection = selectedSchedules.length > 0;
        const bulkArchiveBtn = document.getElementById('bulkArchiveBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const bulkExportBtn = document.getElementById('bulkExportBtn');

        if (bulkArchiveBtn) bulkArchiveBtn.disabled = !hasSelection;
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !hasSelection;
        if (bulkExportBtn) bulkExportBtn.disabled = !hasSelection;
    }

    function duplicateSchedule(sourceId, sourceWeek, sourceYear) {
        const targetWeek = prompt(`Vers quelle semaine voulez-vous dupliquer l'emploi du temps de la semaine ${sourceWeek} ?`, sourceWeek + 1);
        const targetYear = prompt('Pour quelle année ?', sourceYear);

        if (targetWeek && targetYear) {
            const formData = new FormData();
            formData.append('sourceId', sourceId);
            formData.append('targetWeek', targetWeek);
            formData.append('targetYear', targetYear);

            fetch('@Url.Action("DupliquerEmploiTemps", "EmploiTemps")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    if (confirm('Voulez-vous voir le nouvel emploi du temps ?')) {
                        window.location.href = `@Url.Action("VoirEmploiTempsSemaine", "EmploiTemps")?week=${targetWeek}&year=${targetYear}`;
                    }
                } else {
                    showNotification(data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Erreur lors de la duplication', 'danger');
            });
        }
    }

    function changeStatus(id, newStatus) {
        let message = '';
        switch(newStatus) {
            case 'Pending':
                message = 'Voulez-vous soumettre cet emploi du temps pour approbation ?';
                break;
            case 'Approved':
                message = 'Voulez-vous approuver cet emploi du temps ?';
                break;
            case 'Archived':
                message = 'Voulez-vous archiver cet emploi du temps ?';
                break;
        }

        if (confirm(message)) {
            const formData = new FormData();
            formData.append('id', id);
            formData.append('nouveauStatut', newStatus);

            fetch('@Url.Action("ChangerStatut", "EmploiTemps")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Erreur lors du changement de statut', 'danger');
            });
        }
    }

    function deleteSchedule(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer définitivement cet emploi du temps ? Cette action est irréversible.')) {
            const formData = new FormData();
            formData.append('id', id);

            fetch('@Url.Action("SupprimerEmploiTemps", "EmploiTemps")', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message, 'danger');
                }
            })
            .catch(error => {
                showNotification('Erreur lors de la suppression', 'danger');
            });
        }
    }

    function bulkArchive() {
        if (confirm(`Voulez-vous archiver ${selectedSchedules.length} emploi(s) du temps sélectionné(s) ?`)) {
            showNotification(`${selectedSchedules.length} emploi(s) du temps archivé(s)`, 'success');
            selectedSchedules = [];
            updateBulkActionButtons();
        }
    }

    function bulkDelete() {
        if (confirm(`Êtes-vous sûr de vouloir supprimer ${selectedSchedules.length} emploi(s) du temps sélectionné(s) ? Cette action est irréversible.`)) {
            showNotification(`${selectedSchedules.length} emploi(s) du temps supprimé(s)`, 'warning');
            selectedSchedules = [];
            updateBulkActionButtons();
        }
    }

    function bulkExport() {
        showNotification(`Export de ${selectedSchedules.length} emploi(s) du temps en cours...`, 'info');
    }

    function exportHistoryReport() {
        const modal = new bootstrap.Modal(document.getElementById('reportModal'));
        modal.show();
    }

    function generateReport() {
        const reportType = document.getElementById('reportType').value;
        const format = document.querySelector('input[name="format"]:checked').value;
        const includeStats = document.getElementById('includeStats').checked;
        const includeDetails = document.getElementById('includeDetails').checked;
        const includeCharts = document.getElementById('includeCharts').checked;

        showNotification(`Génération du rapport ${reportType} en format ${format.toUpperCase()}...`, 'info');

        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
        modal.hide();
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '1050';
        notification.style.minWidth = '300px';

        const icons = {
            'success': 'fas fa-check-circle',
            'warning': 'fas fa-exclamation-triangle',
            'danger': 'fas fa-exclamation-circle',
            'info': 'fas fa-info-circle'
        };

        notification.innerHTML = `
            <i class="${icons[type]} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>